<div class="text-color mb-24 montserrat">
	<span (click)="goTo(schoolData.slug)" class="text-color-light underline cursor-pointer montserrat">
		{{'menu.home' | translate}}</span> / {{getCourseName(course)}}
</div>

<div *ngIf="course" class="course-reservation-section">
  <div class="course-section">
    <div class="rounded-8 course-image-wrapper">
      <div class="course-image-text" style="padding: 16px 0;">
        <div class="fw-semibold course-image-icon montserrat">
          <img [src]="course.icon" alt="Icono">
          <div class="text-white fw-semibold text-semibig">
            {{getCourseName(course)}}
          </div>
        </div>
      </div>
      <div style="position: relative;">
        <img [src]="course?.image !== null ? course?.image : defaultImage" class="course-image-img"
             style="border-radius: 10px;">
        <span class="last-plaza" *ngIf="course.claim_text">
        {{course.claim_text | translate}}!
      </span>
        <!-- Badge de descuentos disponibles -->
        <div *ngIf="hasDiscountsConfigured()" style="position: absolute; top: 12px; right: 12px; background: linear-gradient(135deg, #FF6B6B 0%, #E91E63 100%); color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 700; box-shadow: 0 4px 12px rgba(233, 30, 99, 0.4); display: flex; align-items: center; gap: 6px; animation: pulse 2s infinite;">
          <span style="font-size: 16px;">🏷️</span>
          <span>{{'discount_available' | translate}}</span>
        </div>
      </div>
    </div>

    <div *ngIf="course" class="course-content">
      <!-- Precio y descuentos -->
      <div style="justify-content: space-between;flex-wrap: wrap;gap: 8px;">
        <div style="min-width: 150px;">
        <span class="price">
          {{ (course.is_flexible ? 'text_from' : '') | translate }}
          {{ course.minPrice | number: '0.2-2' }}
          {{ course.currency }} /
          {{ (course.course_type !== 1 && course.is_flexible ? ('mails.course' | translate: { duration: course.minDuration }) : ('mails.course' | translate)) }}
        </span>
        </div>
        <div>
          <div style="display: flex;align-items: center;" *ngFor="let discount of discounts">
            <img src="assets/icons/start_empty.png" alt class="icon24">
            <span style="color: #E91E63;word-wrap: break-word">
            {{"book"|translate}} {{discount.day}} {{'dates_and_get'|translate}} {{discount.reduccion}}
              {{'discount'|translate}}!
          </span>
          </div>
        </div>
      </div>

      <!-- Rango de fechas general -->
      <div style="gap: 8px;align-items: center;">
        <img src="assets/icons/calendar.png" alt="Calendario" class="icon24">
        <div>
        <span class="descripcion">
          {{"text_from" | translate}}
        </span>
          <span class="campo">
          {{course.date_start | date: 'dd.MM.yyyy' }}
        </span>
          <span class="descripcion">
          {{"text_till" | translate}}
        </span>
          <span class="campo">
          {{course.date_end | date: 'dd.MM.yyyy'}}
        </span>
        </div>
      </div>

      <!-- Fechas detalladas segÃºn el tipo de curso -->
      <div class="dates-detail-container">
        <!-- 1. Para cursos con intervalos -->
        <ng-container *ngIf="shouldDisplayByIntervals()">
          <div class="intervals-list">
            <div *ngIf="getIntervalGroups().length === 0" class="no-dates">
              {{ 'no_future_dates' | translate }}
            </div>

            <div *ngFor="let interval of getIntervalGroups()" class="interval-card">
              <!-- Encabezado del intervalo -->
              <div class="interval-header" (click)="toggleInterval(interval.id)">
                <div class="interval-title-section">
                  <img src="assets/icons/calendar.png" alt="Calendario" class="icon24">
                  <h5 class="interval-name">{{interval.name}}</h5>
                </div>

                <div class="interval-summary">
                <span class="interval-dates">
                  {{interval.startDate | date: 'dd.MM.yyyy'}} - {{interval.endDate | date: 'dd.MM.yyyy'}}
                </span>
                  <span class="interval-weekdays">
                  ({{formatWeekdays(interval.weekdays)}})
                </span>
                  <span *ngIf="interval.time" class="interval-time">
                  {{interval.time}}
                </span>
                  <span class="interval-mode-badge" [class.package]="interval.bookingMode === 'package'">
                  {{ interval.bookingMode === 'package' ? ('booking_interval_package' | translate) : ('booking_interval_flexible' | translate) }}
                </span>
                </div>

                <!-- Información de descuentos disponibles -->
                <div class="interval-discounts-preview" *ngIf="getIntervalDiscounts(interval.id).length > 0" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                  <mat-icon style="color: #FF9800; font-size: 18px; width: 18px; height: 18px;">local_offer</mat-icon>
                  <span style="color: #FF9800; font-size: 13px; font-weight: 500;">
                    {{ 'discount_available' | translate }}:
                  </span>
                  <span *ngFor="let discount of getIntervalDiscounts(interval.id); let last = last" style="color: #FF9800; font-size: 13px;">
                    {{discount.dates}} {{ 'dates' | translate }}:
                    <ng-container *ngIf="discount.type === 'percentage'">
                      -{{discount.value}}%
                    </ng-container>
                    <ng-container *ngIf="discount.type === 'fixed'">
                      -{{discount.value}} {{course.currency}}
                    </ng-container>
                    <span *ngIf="!last"> • </span>
                  </span>
                </div>

                <div class="interval-reservable-info" *ngIf="interval.reservableWindowKey">
                  {{ interval.reservableWindowKey | translate: interval.reservableWindowParams }}
                </div>
                <div class="interval-reservable-warning" *ngIf="interval.reservableStatusKey">
                  {{ interval.reservableStatusKey | translate: interval.reservableStatusParams }}
                </div>

                <div class="toggle-icon">
                  <img src="assets/icons/arrow-down.png"
                       [class.arrow-rotated]="isIntervalExpanded(interval.id)"
                       alt="Expandir/Colapsar">
                </div>
              </div>

              <!-- Contenido del intervalo expandible -->
              <div class="interval-content" *ngIf="isIntervalExpanded(interval.id)">
                <div class="dates-grid">
                  <div *ngFor="let date of interval.dates" class="date-item">
                    <div class="date-day">
                      <span class="day-number">{{date.date | date: 'dd'}}</span>
                      <span class="month-year">{{date.date | date: 'MMM yyyy'}}</span>
                    </div>
                    <div class="date-weekday">
                      {{getWeekdayNameFromDate(date.date)}}
                    </div>
                    <div class="date-time">
                      {{date.hour_start}}h - {{date.hour_end}}h
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- 2. Para cursos flexibles sin intervalos (agrupados por semanas) -->
        <ng-container *ngIf="shouldDisplayByWeeks()">
          <div class="weeks-list">
            <div *ngIf="getWeekGroups().length === 0" class="no-dates">
              {{ 'no_future_dates' | translate }}
            </div>

            <div *ngFor="let week of getWeekGroups()" class="week-card">
              <!-- Encabezado de la semana -->
              <div class="week-header" (click)="toggleInterval(week.id)">
                <div class="week-title-section">
                  <img src="assets/icons/calendar.png" alt="Calendario" class="icon24">
                  <h5 class="week-name">{{week.name}}</h5>
                </div>

                <div class="week-summary">
                <span class="week-dates">
                  {{week.startDate | date: 'dd.MM.yyyy'}} - {{week.endDate | date: 'dd.MM.yyyy'}}
                </span>
                  <span class="week-weekdays">
                  ({{formatWeekdays(week.weekdays)}})
                </span>
                  <span *ngIf="week.time" class="week-time">
                  {{week.time}}
                </span>
                </div>

                <div class="toggle-icon">
                  <img src="assets/icons/arrow-down.png"
                       [class.arrow-rotated]="isIntervalExpanded(week.id)"
                       alt="Expandir/Colapsar">
                </div>
              </div>

              <!-- Contenido de la semana expandible -->
              <div class="week-content" *ngIf="isIntervalExpanded(week.id)">
                <div class="dates-grid">
                  <div *ngFor="let date of week.dates" class="date-item">
                    <div class="date-day">
                      <span class="day-number">{{date.date | date: 'dd'}}</span>
                      <span class="month-year">{{date.date | date: 'MMM yyyy'}}</span>
                    </div>
                    <div class="date-weekday">
                      {{getWeekdayNameFromDate(date.date)}}
                    </div>
                    <div class="date-time">
                      {{date.hour_start}}h - {{date.hour_end}}h
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- 3. Para cursos no flexibles sin intervalos (original) -->
        <ng-container *ngIf="shouldDisplaySimpleDates()">
          <div class="simple-dates-list">
            <div *ngIf="getFutureDates().length === 0" class="no-dates">
              {{ 'no_future_dates' | translate }}
            </div>

            <div class="dates-grid">
              <div *ngFor="let date of getFutureDates()" class="date-item">
                <div class="date-day">
                  <span class="day-number">{{date.date | date: 'dd'}}</span>
                  <span class="month-year">{{date.date | date: 'MMM yyyy'}}</span>
                </div>
                <div class="date-weekday">
                  {{getWeekdayNameFromDate(date.date)}}
                </div>
                <div class="date-time">
                  {{date.hour_start}}h - {{date.hour_end}}h
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- 4. Para cursos privados (misma estructura original) -->
        <ng-container *ngIf="course.course_type == 2">
          <div class="private-course-dates">
            <div class="week-info-container">
              <div class="weekdays-info">
                {{ getWeekdays(course.settings) }}
              </div>

              <div class="duration-info">
                <span class="duration-label">{{'text_from_price' | translate}}</span>
                <span class="duration-value">{{course.duration}}</span>
              </div>

              <div class="hours-info">
                <span class="hours-label">{{'schedule' | translate}}:</span>
                <span class="hours-value">{{course.hour_min}}h - {{course.hour_max}}h</span>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

      <!-- NÃºmero mÃ¡ximo de participantes -->
      <div style="gap: 8px;align-items: center;">
        <img src="assets/icons/people.png" alt="Grupo mÃ¡ximo" class="icon24">
        <span class="campo2">
        {{"max_pax" | translate}} {{course.max_participants}}
      </span>
        <span *ngIf="course.age_max<99 && course.age_min>1" class="campo2">
        ,{{course.age_min}}-{{course.age_max}}+ {{"text_years" | translate}}
      </span>
      </div>

      <!-- SecciÃ³n de resumen -->
      <span class="descripcion2"> {{"summary"|translate|uppercase}} </span>
      <div [innerHTML]="getShotrDescription(course)" class="show-desktop text-color-light montserrat"></div>

      <!-- SecciÃ³n de descripciÃ³n -->
      <span class="descripcion2"> {{"courses.desc"|translate|uppercase}} </span>
      <div [innerHTML]="getDescription(course)" class="show-desktop text-color-light montserrat"></div>

      <!-- SecciÃ³n de niveles disponibles -->
      <ng-container *ngIf="course.availableDegrees.length>0">
      <span class="descripcion2">
        {{"levels"|translate|uppercase}}
      </span>
        <div style="display: flex;flex-wrap: wrap;gap: 5px;">
        <span *ngFor="let item of course.availableDegrees" [style.backgroundColor]="item.color"
              style="color: white; width: fit-content;padding: 10px;height: 36px;border-radius: 3px;">
          {{item.name}}
        </span>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Reservation -->
  <div class="reservation-section">
    <div class="rounded-8 reservation-box">
      <div *ngIf="!userLogged" class="reservation-box" style="padding: 20px;">
        <div style="width: 100%;" class="text-color montserrat">
          {{'text_booking1' | translate }}
        </div>
        <button (click)="schoolService.isModalLogin=true"
                style="height: 40px;border-radius: 3px;color: white;background-color: #E91E63;"
                class="rounded-8 button-style cursor-pointer width-100" type="button">
          {{'text_already_client' | translate }}
        </button>
        <button (click)="schoolService.isModalNewUser = !schoolService.isModalNewUser"
                style="height: 40px;border-radius: 3px;background-color: white;border:1px solid black;"
                class="rounded-8 button-style cursor-pointer width-100" type="button">
          {{'text_new_client' | translate }}
        </button>
      </div>
      <div *ngIf="isSmallScreen && userLogged && course && !SmallScreenModal" style="display: flex;    justify-content: center;    padding: 16px;
        height: 70px;
        width: 100%;
        gap: 16px;">
        <div class="reservation-price-flex" style="justify-content: space-around;">
          <div class="text-medium text-color uppercase">
            {{'text_price' | translate }}
          </div>
          <div *ngIf="!course.is_flexible" class="text-medium text-color" style="text-align: -webkit-center;">
            <span class="text-color text-medium fw-bold">{{course?.price|number:'0.2-2'}}</span>
            {{ course?.currency }}
          </div>
          <div *ngIf="course.is_flexible" class="text-medium text-color" style="text-align: -webkit-center;">
            <!-- Precio con descuento aplicado -->
            <div *ngIf="hasActiveDiscount" style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
              <span style="text-decoration: line-through; font-size: 12px; color: #999;">
                {{originalPrice|number:'0.2-2'}} {{ course?.currency }}
              </span>
              <span class="text-color text-medium fw-bold" style="color: #E91E63;">
                {{collectivePrice|number:'0.2-2'}}
              </span>
              <span style="font-size: 11px; color: #4CAF50; font-weight: 600;">
                {{'discount_save' | translate}} {{appliedDiscountAmount|number:'0.2-2'}} {{ course?.currency }}
              </span>
            </div>
            <!-- Precio sin descuento -->
            <span *ngIf="!hasActiveDiscount" class="text-color text-medium fw-bold">{{collectivePrice|number:'0.2-2'}}</span>
            {{ course?.currency }} /{{'date' |
            translate }}
          </div>
        </div>
        <!-- Mensaje incentivador si hay descuentos disponibles -->
        <div *ngIf="course.is_flexible && hasDiscountsConfigured() && getNextDiscount()"
             style="margin-top: 12px; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px; text-align: center;">
          <div style="color: white; font-size: 12px; font-weight: 600; line-height: 1.4;">
            <span style="font-size: 16px;">🎁</span>
            {{'discount_add' | translate}} {{getNextDiscount().days - (selectedDates?.length || 0)}}
            {{'discount_more_days' | translate}}
            <span style="display: block; margin-top: 4px; font-size: 13px;">
              {{'discount_save_up_to' | translate}}
              <strong *ngIf="getNextDiscount().type === 'percentage'">{{getNextDiscount().value}}%</strong>
              <strong *ngIf="getNextDiscount().type === 'fixed'">{{getNextDiscount().value}} {{ course?.currency }}</strong>
            </span>
          </div>
        </div>
        <button (click)="SmallScreenModal=true" style="
            background-color: rgba(233, 30, 99, 1);
            width: 100%;border-radius: 3px;
            height: 38px;padding: 10px 12px;
            color: white;
             font-weight: 600;
             word-wrap: break-word" type="button">
          {{'continue' | translate }}
        </button>
      </div>
      <div *ngIf="(!isSmallScreen || isSmallScreen && SmallScreenModal) && userLogged && course"
           class="reservation-view">
        <div class="titlexxxx">
          {{'text_new_booking' | translate }}
          <img (click)="SmallScreenModal=false" src="assets/icons/x.png"
               style="margin-left: auto;cursor: pointer;" class="icon24">
        </div>
        <div
          style="height: 48px; padding: 16px 20px;display: flex;border-bottom: 1px solid rgba(222, 230, 234, 1);align-items: center;">
					<span [style.color]="courseFlux===0?'#E91E63':'#8B9099'" class="placeLevel" (click)="courseFlux=0">
						{{"participant"|translate|uppercase}}
					</span>
          <img src="assets/icons/arrow-right.png" class="icon20">
          <span [style.color]="courseFlux===1?'#E91E63':'#8B9099'" class="placeLevel"
                (click)="courseFlux>1?courseFlux=1:null">
						{{"level"|translate|uppercase}}
					</span>
          <img *ngIf="course.is_flexible || course.course_type===2" src="assets/icons/arrow-right.png"
               class="icon20">
          <span *ngIf="course.is_flexible || course.course_type===2"
                [style.color]="courseFlux===2?'#E91E63':'#8B9099'" class="placeLevel"
                (click)="courseFlux>2?courseFlux=2:null">
						{{"date"|translate|uppercase}}
					</span>
          <img src="assets/icons/arrow-right.png" class="icon20">
          <span [style.color]="courseFlux===3?'#E91E63':'#8B9099'" class="placeLevel">
						{{"extras"|translate|uppercase}}
					</span>
        </div>

        <div [style.display]="courseFlux===0 ? 'block' : 'none'" class="reservation-users" style="padding: 20px;">
          <div style="word-wrap: break-word;margin-bottom: 10px;">
            <ng-container *ngIf="course?.course_type === 2">
              {{'text_select_user_or_more' | translate }}
              {{course?.max_participants}}
            </ng-container>
            <ng-container *ngIf="!(course?.course_type === 2)">
              {{'text_select_user' | translate }}
            </ng-container>
          </div>

          <mat-checkbox (click)="selectUser(userLogged.clients[0],course?.course_type)"
                        [checked]="course?.course_type === 2 ? selectedUserMultiple.includes(userLogged.clients[0]) : selectedUser === userLogged.clients[0]"
                        style="height: 64px;width: 100%;border-radius: 3px;border: 1px solid rgba(34, 34, 34, 1);">
            <div style="display: flex;gap: 8px;padding: 12px 0;">
              <app-level-user *ngIf="dataLevels && dataLevels.length" [allLevels]="dataLevels"
                              [selectLevel]="getUserSportDegreeId(userLogged.clients[0])" [size]="40"
                              [userImage]="userLogged?.clients[0].image || 'assets/images/avatar.png'"></app-level-user>
              <div class="text-color text-small montserrat reservation-user-title">
                <div style="text-align: -webkit-left;">
									<span style="font-weight: 600;">
										{{userLogged?.clients[0].first_name}}
                    {{userLogged?.clients[0].last_name}}
									</span>
                  <img src="assets/images/gold-crown.png"
                       style="display: inline;vertical-align: baseline;">
                  <br>
                  <span style="color: #8B9099;font-size: 12px;">
										{{getLanguage(userLogged?.clients[0]?.language1_id)}}
                    · {{getCountry(userLogged?.clients[0]?.country)}} ·
                    {{calculateAge(userLogged?.clients[0]?.birth_date)}} {{'years' |
                    translate }}
									</span>
                </div>
              </div>
            </div>
          </mat-checkbox>
          <mat-checkbox *ngFor="let utilizer of userLogged?.clients[0].utilizers"
                         [ngClass]="{'opacity-full': (course?.course_type === 2 && selectedUserMultiple.includes(utilizer)) || (!(course?.course_type === 2) && selectedUser === utilizer)}"
                        (click)="selectUser(utilizer,course?.course_type)"
                        [checked]="course?.course_type === 2 ? selectedUserMultiple.includes(utilizer) : selectedUser === utilizer"
                        style="height: 64px;width: 100%;border-radius: 3px;border: 1px solid rgba(34, 34, 34, 1);">
            <div style="display: flex;gap: 8px;padding: 12px 0;">
              <app-level-user *ngIf="dataLevels && dataLevels.length" [allLevels]="dataLevels"
                              [selectLevel]="getUserSportDegreeId(utilizer)" [size]="40"
                              [userImage]="themeService.avatarEmpty || 'assets/images/avatar.png'"></app-level-user>
              <div class="text-color text-small montserrat reservation-user-title">
                <div style="text-align: -webkit-left;">
									<span style="font-weight: 600;">
										{{utilizer.first_name}} {{utilizer.last_name}}
									</span>
                  <br>
                  <span style="color: #8B9099;font-size: 12px;">
										{{getLanguage(utilizer.language1_id)}}
                    · {{getCountry(utilizer.country)}} ·
                    {{calculateAge(utilizer.birth_date)}} {{'years' |
                    translate }}
									</span>
                </div>
              </div>
            </div>
          </mat-checkbox>

          <button (click)="isModalAddUser=true"
                  style="height: 40px;padding: 10px;width: 100%;border-radius: 3px;border: 1px solid rgba(34, 34, 34, 1);">
            {{'text_add' | translate }} {{'text_user' | translate }}
          </button>
        </div>

        <div [style.display]="courseFlux===1 ? 'block' : 'none'" style="padding: 20px;">
          <div>
            {{'text_select_level' | translate }}
          </div>
          <div *ngIf="course.availableDegrees.length==0" style="
            background-color: rgba(210, 239, 255, 1);
        border-radius: 8px;margin-top: 12px;
            padding: 10px;display: flex;gap: 8px; align-items: center;
           word-wrap: break-word">
            <img src="assets/icons/info.png" alt class="icon24">
            {{ 'text_no_level' | translate }}
          </div>
          <div>
            <!-- <div *ngIf="selectedLevel" class="rounded-8 level-wrapper"
              (mouseenter)="showTooltipFilter(0)"
              (mouseleave)="hideTooltipFilter(0)">
              <div
                [ngStyle]="{'color': selectedLevel.color}">{{selectedLevel.league}}</div>
              <div class="text-color">{{selectedLevel.name}}</div>
              <div class="level-check">
                <img src="assets/icons/check.png" />
              </div>

              <div class="tooltip-container-level background-color-trans"

                  *ngIf="tooltipsFilter[0]" [@fadeInOut]>
                <div class="text-small montserrat text-color-light"

                    *ngFor="let goal of selectedLevel.degrees_school_sport_goals">
                  {{goal.name}}
                </div>
              </div>
            </div>

            <div
              class="text-color montserrat cursor-pointer reservation-return mt-24 mb-24"
              (click)="showLevels=!showLevels">
              <img [src]="themeService.edit">
              {{'text_change_level' | translate }}
            </div> -->
            <!-- showLevels && -->
            <div class="levels-section" style="margin-top: 20px;">

              <ng-container *ngFor="let level of course.availableDegrees.length > 0 ? course.availableDegrees : dataLevels; let i = index">
                <ng-container *ngIf="findMatchingUser(level)">
                  <div *ngIf="i === 0 || level.league !== (course.availableDegrees.length > 0 ? course.availableDegrees : dataLevels)[i-1].league"
                       style="color: #8B9099; font-weight: 600; line-height: 16px;">
                    {{ level.league }}
                  </div>

                  <div class="checkbox-container" style="position: relative; display: flex; align-items: center;">
                    <!-- Mat checkbox -->
                    <mat-checkbox
                      [ngStyle]="{'background-color': level.color+'33', 'border': '1px solid '+level.color}"
                      (click)="selectLevel(level)"
                      [checked]="selectedLevel?.id === level.id"
                      style="width: 100%; border-radius: 3px; border: 1px solid rgba(34, 34, 34, 1);">
                      <div style="display: flex; gap: 8px; padding: 12px 0;">
                        <div [ngStyle]="{'color': level.color}" style="font-size: 12px; line-height: 16px;">
                          {{ level.annotation }} {{ level.name }}
                        </div>
                      </div>
                    </mat-checkbox>

                    <!-- Info button outside of the checkbox -->
                    <img src="assets/icons/info.png"
                         (click)="showTooltip(i); $event.stopPropagation();"
                         class="info-icon"
                         alt="Info">
                    <!-- Tooltip -->
                    <div *ngIf="tooltipVisible[i]" class="tooltip-container">
                      <div class="tooltip-title">{{ 'objectives' | translate }}</div>
                      <ul>
                        <li *ngFor="let goal of level.degrees_school_sport_goals">
                          {{ goal.name }}
                        </li>
                      </ul>
                    </div>
                  </div>



                </ng-container>
              </ng-container>

            </div>
            <div
              *ngIf="showLevels && course?.availableDegrees && course?.availableDegrees.length && !hasLevelsAvailable">
              <p>
                {{'text_no_degrees' | translate }}
              </p>
            </div>
          </div>
        </div>
        <!-- SecciÃ³n de reserva para cursos -->
        <div *ngIf="course?.course_type==1 && course.is_flexible && courseFlux===2" class="date-selection-container">
          <div class="date-selection-title">
            {{"select_dates_to_book" | translate}}
          </div>

          <!-- Si hay un error de selecciÃ³n, mostrarlo -->
          <div *ngIf="dateSelectionError" class="date-selection-error">
            <mat-icon>error_outline</mat-icon>
            <span>{{dateSelectionError}}</span>
          </div>

          <!-- InformaciÃ³n sobre restricciones -->
          <div *ngIf="!hasIntervals() && (mustBeConsecutive() || mustStartFromFirst())" class="booking-restrictions">
            <div class="restriction-title">{{ 'important_information' | translate }}:</div>
            <ul class="restriction-list">
              <li *ngIf="mustBeConsecutive()">
                <mat-icon>date_range</mat-icon>
                <span>{{ 'consecutive_dates_required' | translate }}</span>
                <mat-icon class="info-tooltip" matTooltip="{{ 'consecutive_dates_info' | translate }}">info</mat-icon>
              </li>
              <li *ngIf="mustStartFromFirst()">
                <mat-icon>play_arrow</mat-icon>
                <span>{{ 'must_start_first_day' | translate }}</span>
                <mat-icon class="info-tooltip" matTooltip="{{ 'first_day_info' | translate }}">info</mat-icon>
              </li>
            </ul>
          </div>

          <!-- OpciÃ³n 1: Curso con intervalos -->
          <div *ngIf="hasIntervals()" class="interval-selection-container">
            <div class="interval-overview">
              {{ 'booking_multi_interval_help' | translate }}
            </div>
            <div class="interval-rules-panel">
              <ng-container *ngIf="selectedIntervalId && getSelectedIntervalRules().length; else intervalRulesHint">
                <div class="restriction-title">
                  {{ 'booking_interval_rules_title' | translate:{ intervalName: getIntervalDisplayName(selectedIntervalId) || ('booking_interval_default_name' | translate) } }}
                </div>
                <ul class="restriction-list">
                  <li *ngFor="let rule of getSelectedIntervalRules()">
                    <mat-icon>{{ rule.icon }}</mat-icon>
                    <span>{{ rule.key | translate:(rule.params || {}) }}</span>
                    <mat-icon *ngIf="rule.tooltipKey" class="info-tooltip" matTooltip="{{ rule.tooltipKey | translate:(rule.tooltipParams || {}) }}">info</mat-icon>
                  </li>
                </ul>
              </ng-container>
              <ng-template #intervalRulesHint>
                <div class="restriction-placeholder">
                  {{ 'booking_interval_rules_placeholder' | translate }}
                </div>
              </ng-template>
            </div>
            <!-- Lista de intervalos -->
            <div class="intervals-list">
              <div *ngFor="let interval of getIntervalGroups(); trackBy: trackByIntervalId"
                   [class.interval-card]="true"
                   [class.interval-selected]="isIntervalSelected(interval.id)"
                   [class.interval-disabled]="!interval.isReservableNow">
                <!-- Encabezado del intervalo -->
                <div class="interval-header"
                     [class.cursor-not-allowed]="!interval.isReservableNow"
                     [attr.title]="!interval.isReservableNow ? (interval.reservableStatusKey | translate:interval.reservableStatusParams) : null"
                     (click)="interval.isReservableNow && toggleIntervalExpanded(interval.id)">
                  <div class="interval-title-section">
                    <mat-icon *ngIf="!interval.isReservableNow" class="disabled-icon">block</mat-icon>
                    <h5 class="interval-name">{{interval.name}}</h5>
                  </div>

                  <div class="interval-expand-icon">
                    <mat-icon *ngIf="interval.isReservableNow && !isIntervalExpanded(interval.id)">expand_more</mat-icon>
                    <mat-icon *ngIf="interval.isReservableNow && isIntervalExpanded(interval.id)">expand_less</mat-icon>
                  </div>

                  <div class="interval-summary">
                    <span class="interval-dates">
                      {{interval.startDate | date: 'dd.MM.yyyy'}} - {{interval.endDate | date: 'dd.MM.yyyy'}}
                    </span>
                    <span class="interval-count">
                      ({{interval.count}} {{ 'dates' | translate }})
                    </span>
                    <span class="interval-mode-badge" [class.package]="interval.bookingMode === 'package'">
                      {{ interval.bookingMode === 'package' ? ('booking_interval_package' | translate) : ('booking_interval_flexible' | translate) }}
                    </span>
                  </div>

                  <!-- Información de descuentos disponibles -->
                  <div class="interval-discounts-info" *ngIf="getIntervalDiscounts(interval.id).length > 0">
                    <!-- Descuento aplicado -->
                    <div *ngIf="getAppliedIntervalDiscount(interval.id) as appliedDiscount" class="discount-applied">
                      <mat-icon style="color: #4CAF50; font-size: 18px;">check_circle</mat-icon>
                      <span style="color: #4CAF50; font-weight: 600;">
                        {{ 'discount_applied' | translate }}:
                        <ng-container *ngIf="appliedDiscount.type === 'percentage'">
                          {{appliedDiscount.value}}%
                        </ng-container>
                        <ng-container *ngIf="appliedDiscount.type === 'fixed'">
                          {{appliedDiscount.value}} {{course.currency}}
                        </ng-container>
                      </span>
                    </div>

                    <!-- Próximo descuento disponible -->
                    <div *ngIf="getNextIntervalDiscount(interval.id) as nextDiscount" class="discount-available">
                      <mat-icon style="color: #E91E63; font-size: 18px;">local_offer</mat-icon>
                      <span style="color: #E91E63; font-weight: 500;">
                        {{ 'booking.interval.discount_hint' | translate: {
                          dates: nextDiscount.dates,
                          discount: nextDiscount.type === 'percentage' ? (nextDiscount.value + '%') : (nextDiscount.value + ' ' + course.currency)
                        } }}
                      </span>
                    </div>

                    <!-- Mostrar todos los descuentos disponibles cuando no hay ninguno aplicado -->
                    <div *ngIf="!getAppliedIntervalDiscount(interval.id)" class="discounts-list">
                      <div *ngFor="let discount of getIntervalDiscounts(interval.id)" class="discount-item">
                        <mat-icon style="color: #FF9800; font-size: 16px;">star</mat-icon>
                        <span style="color: #FF9800; font-size: 13px;">
                          {{discount.dates}} {{ 'dates' | translate }}:
                          <ng-container *ngIf="discount.type === 'percentage'">
                            -{{discount.value}}%
                          </ng-container>
                          <ng-container *ngIf="discount.type === 'fixed'">
                            -{{discount.value}} {{course.currency}}
                          </ng-container>
                        </span>
                      </div>
                    </div>
                  </div>

                  <div class="interval-additional-info" *ngIf="interval.reservableWindowKey || interval.reservableStatusKey">
                    <div class="interval-reservable-info" *ngIf="interval.reservableWindowKey">
                      <mat-icon>schedule</mat-icon>
                      <span>{{ interval.reservableWindowKey | translate: interval.reservableWindowParams }}</span>
                    </div>
                    <div class="interval-reservable-warning" *ngIf="interval.reservableStatusKey">
                      <mat-icon>info</mat-icon>
                      <span>{{ interval.reservableStatusKey | translate: interval.reservableStatusParams }}</span>
                    </div>
                  </div>
                </div>

                <!-- Fechas del intervalo (visibles cuando estÃ¡ seleccionado) -->
                <div class="interval-dates-container" *ngIf="isIntervalExpanded(interval.id)">
                  <div class="date-checkboxes">
                    <div *ngFor="let date of interval.dates; trackBy: trackByDate" class="date-checkbox-wrapper"
                         [class.date-disabled]="!isDateAvailable(date.date, interval.id) || interval.bookingMode === 'package'"
                         [class.date-selected]="isDateSelected(date.date)">
                      <mat-checkbox
                        (change)="selectDate($event.checked, date.date, interval.id)"
                        [checked]="isDateSelected(date.date)"
                        [disabled]="!isDateAvailable(date.date, interval.id) || interval.bookingMode === 'package'">
                        <div class="date-checkbox-content">
                          <span class="date-day">{{date.date | date: 'dd'}}</span>
                          <span class="date-month-year">{{date.date | date: 'MMM yyyy'}}</span>
                          <span class="date-time">{{date.hour_start}}h-{{date.hour_end}}h</span>
                        </div>
                      </mat-checkbox>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- OpciÃ³n 2: Curso flexible SIN intervalos (agrupado por semanas) -->
          <div *ngIf="!hasIntervals() && course.is_flexible" class="week-selection-container">
            <!-- AgrupaciÃ³n por semanas -->
            <div class="weeks-list">
              <div *ngFor="let week of getWeekGroups()" class="week-card">
                <!-- Encabezado de la semana -->
                <div class="week-header">
                  <div class="week-title-section">
                    <mat-icon>date_range</mat-icon>
                    <h5 class="week-name">{{week.name}}</h5>
                  </div>

                  <div class="week-summary">
            <span class="week-dates">
              {{week.startDate | date: 'dd.MM.yyyy'}} - {{week.endDate | date: 'dd.MM.yyyy'}}
            </span>
                    <span class="week-count">
              ({{week.count}} {{ 'dates' | translate }})
            </span>
                  </div>
                </div>

                <!-- Fechas de la semana -->
                <div class="week-dates-container">
                  <div class="date-checkboxes week-dates-grid">
                    <div *ngFor="let date of week.dates" class="date-checkbox-wrapper"
                         [class.date-disabled]="!isDateAvailable(date.date)"
                         [class.date-selected]="isDateSelected(date.date)">
                      <mat-checkbox
                        (change)="selectDate($event.checked, date.date)"
                        [checked]="isDateSelected(date.date)"
                        [disabled]="!isDateAvailable(date.date)">
                        <div class="date-checkbox-content">
                          <span class="date-day">{{date.date | date: 'dd'}}</span>
                          <span class="date-month-year">{{date.date | date: 'MMM yyyy'}}</span>
                          <span class="date-time">{{date.hour_start}}h-{{date.hour_end}}h</span>
                        </div>
                      </mat-checkbox>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- OpciÃ³n 3: VisualizaciÃ³n original (para mantener compatibilidad) -->
          <div *ngIf="!hasIntervals() && !course.is_flexible" class="simple-dates-container">
            <div class="simple-dates-grid">
              <ng-container *ngFor="let date of getFutureDates()">
                <mat-checkbox
                  (change)="selectDate($event.checked, date.date)"
                  [checked]="isDateSelected(date.date)"
                  [ngClass]="{'date-disabled': !isDateAvailable(date.date)}"
                  [disabled]="!isDateAvailable(date.date)"
                  class="simple-date-checkbox">
                  {{date.date | date: 'dd.MM.yyyy'}}
                </mat-checkbox>
              </ng-container>
            </div>
          </div>

          <!-- Resumen de selecciÃ³n mejorado -->
          <div *ngIf="selectedDates.length > 0" class="selected-dates-summary">
            <div class="summary-header">
              <mat-icon class="summary-icon">event_note</mat-icon>
              <div class="summary-title">
                {{ 'selected_dates' | translate }}
              </div>
              <div class="summary-count">
                {{selectedDates.length}} {{ selectedDates.length === 1 ? ('date' | translate) : ('dates' | translate) }}
              </div>
            </div>

            <!-- Si hay múltiples intervalos, agrupar por intervalo -->
            <div *ngIf="getSelectedDatesByInterval().length > 1" class="selected-dates-by-interval">
              <div *ngFor="let interval of getSelectedDatesByInterval()" style="margin-bottom: 20px;">
                <div style="font-weight: 700; font-size: 13px; color: #E91E63; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #E91E63; display: flex; align-items: center; gap: 6px;">
                  <mat-icon style="font-size: 18px; width: 18px; height: 18px;">event</mat-icon>
                  {{interval.name}}
                  <span style="font-weight: 400; font-size: 12px; opacity: 0.8;">({{interval.dates.length}} {{ interval.dates.length === 1 ? ('date' | translate) : ('dates' | translate) }})</span>
                </div>
                <div class="selected-dates-grid">
                  <div *ngFor="let date of interval.dates" class="selected-date-card">
                    <div class="selected-date-content">
                      <div class="selected-date-day">
                        {{ date | date: 'dd' }}
                      </div>
                      <div class="selected-date-details">
                        <div class="selected-date-month">{{ date | date: 'MMM yyyy' }}</div>
                        <div class="selected-date-weekday">{{ getWeekday(date) }}</div>
                      </div>
                    </div>
                    <button mat-icon-button
                            class="selected-date-remove"
                            (click)="selectDate(false, date, getIntervalForDate(date))"
                            matTooltip="{{ 'remove_date' | translate }}">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Si hay un solo intervalo o no hay intervalos, mostrar sin agrupar -->
            <div *ngIf="getSelectedDatesByInterval().length <= 1" class="selected-dates-grid">
              <div *ngFor="let date of selectedDates" class="selected-date-card">
                <div class="selected-date-content">
                  <div class="selected-date-day">
                    {{ date | date: 'dd' }}
                  </div>
                  <div class="selected-date-details">
                    <div class="selected-date-month">{{ date | date: 'MMM yyyy' }}</div>
                    <div class="selected-date-weekday">{{ getWeekday(date) }}</div>
                  </div>
                </div>
                <button mat-icon-button
                        class="selected-date-remove"
                        (click)="selectDate(false, date, getIntervalForDate(date))"
                        matTooltip="{{ 'remove_date' | translate }}">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>

            <div class="selection-summary-actions">
              <button mat-stroked-button
                      color="warn"
                      (click)="clearAllDates()"
                      class="clear-all-btn">
                <mat-icon>clear_all</mat-icon>
                {{ 'clear_all' | translate }}
              </button>
              <div class="selected-total-info">
                {{ 'total_selected' | translate }}:
                <span class="total-count">{{ selectedDates.length }}</span>
              </div>
            </div>

            <!-- Fallback warning when discount calculation is unreliable -->
            <div *ngIf="discountSource === 'legacy' || discountSource === 'error'"
                 style="background: #FFF3CD; border: 1px solid #FFC107; padding: 12px; border-radius: 4px; margin-bottom: 12px; display: flex; gap: 8px; align-items: flex-start;">
              <span style="font-size: 18px; flex-shrink: 0;">⚠️</span>
              <div style="font-size: 14px; color: #856404; line-height: 1.4;">
                <strong *ngIf="discountSource === 'error'">{{ 'error_calculating_discount' | translate }}</strong>
                <strong *ngIf="discountSource === 'legacy'">{{ 'discount_calculated_locally' | translate }}</strong>
              </div>
            </div>

            <!-- Price breakdown with discounts -->
            <div class="price-breakdown-summary" style="margin-top: 16px; padding: 16px; background: #F5F7FA; border-radius: 8px;">
              <!-- Original price if discount applied -->
              <div *ngIf="hasActiveDiscount" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #8B9099; font-size: 14px;">{{ 'original_price' | translate }}</span>
                <span style="color: #8B9099; text-decoration: line-through; font-size: 14px;">
                  {{originalPrice | number:'0.2-2'}} {{course.currency}}
                </span>
              </div>

              <!-- Discount applied by interval -->
              <div *ngIf="hasActiveDiscount && discountsByInterval.length > 0" style="margin-bottom: 8px;">
                <div *ngFor="let intervalDiscount of discountsByInterval" style="display: flex; justify-content: space-between; margin-bottom: 6px; padding-left: 8px; border-left: 3px solid #4CAF50;">
                  <span style="color: #4CAF50; font-size: 13px; font-weight: 500;">
                    {{ intervalDiscount.intervalName }}
                    <span *ngIf="intervalDiscount.discountPercentage > 0" style="font-size: 12px; opacity: 0.8;">
                      (-{{intervalDiscount.discountPercentage}}%)
                    </span>
                  </span>
                  <span style="color: #4CAF50; font-weight: 600; font-size: 13px;">
                    -{{intervalDiscount.discountAmount | number:'0.2-2'}} {{course.currency}}
                  </span>
                </div>
              </div>

              <!-- Total discount -->
              <div *ngIf="hasActiveDiscount" style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-top: 8px; border-top: 1px solid #DEE6EA;">
                <span style="color: #4CAF50; font-size: 14px; font-weight: 600;">{{ 'discount_applied' | translate }}</span>
                <span style="color: #4CAF50; font-weight: 700; font-size: 14px;">
                  -{{appliedDiscountAmount | number:'0.2-2'}} {{course.currency}}
                </span>
              </div>

              <!-- Final price -->
              <div style="display: flex; justify-content: space-between; border-top: 2px solid #DEE6EA; padding-top: 12px; margin-top: 8px;">
                <span style="font-weight: 700; font-size: 16px; color: #222222;">{{ 'text_price' | translate }}</span>
                <span style="font-weight: 700; font-size: 18px; color: #E91E63;">
                  {{collectivePrice | number:'0.2-2'}} {{course.currency}}
                </span>
              </div>
            </div>
          </div>
        </div>
<!--        <div [style.display]="course?.course_type==1 && course.is_flexible && courseFlux===2 ? 'block' : 'none'"  style="padding: 20px;">
          <div>
            {{"select_dates_to_book" | translate}}
          </div>
          <div style="display: flex;flex-wrap: wrap;justify-content: space-between;;">
            <ng-container *ngFor="let date of course.course_dates">
              <mat-checkbox (change)="selectDate($event.checked,date.date)" *ngIf="Date(date.date)>=today"
                            [checked]="selectedDates.includes(date.date)" style="font-weight: 600;">
                {{date.date | date: 'dd.MM.yyyy'}}
              </mat-checkbox>
            </ng-container>
          </div>
        </div>-->
        <div [style.display]="course?.course_type==2 && courseFlux===2 ? 'block' : 'none'" style="padding: 20px;">
          <ng-container *ngIf="selectedUserMultiple && selectedUserMultiple.length">
            <div class="text-color montserrat mt-12 margin-auto">
              {{'text_select_date_disponibility' | translate }}
            </div>
            <div class="calendar-reservation-section">
              <div class="calendar">
                <div class="header-calendar">
                  <div class="header-calendar-arrows">
                    <img [src]="themeService.arrowLeft" (click)="prevMonth()">
                    <img [src]="themeService.arrowRight" (click)="nextMonth()">
                  </div>
                  <div class="text-color text-semibig fw-medium">
                    {{monthNames[currentMonth] }}
                  </div>
                  <div class="text-color text-semibig fw-medium">
                    {{currentYear}}
                  </div>
                </div>
                <div class="weekdays">
									<span *ngFor="let day of weekdays" class="montserrat text-small text-color-light">
										{{ day }}
									</span>
                </div>
                <div class="days">
                  <ng-container *ngFor="let day of days">
										<span [ngClass]="{'very-light-opacity': day.past}" (click)="selectDay(day)"
                          class="montserrat day-span-a">
											<span [ngClass]="{
                                                  'active-collective': day.active && course.course_type == 1,
                                                  'active-collective-selected': day.selected && course.course_type == 1,
                                                  'active-private': day.active  && course.course_type == 2,
                                                  'active-private-selected': day.selected  && course.course_type == 2
                                                  }" class="day-span-b text-color">
												{{ day.number }}
											</span>
										</span>
                  </ng-container>
                </div>
              </div>
            </div>
            <div style="display: flex;flex-wrap: wrap;gap: 16px; margin-top: 20px;">
              <!--              <mat-form-field appearance="outline" style="width: calc(50% - 8px);" label="hour">
                              <mat-label>{{ 'hour' | translate }}</mat-label>
                              <mat-select [(value)]="selectedHour">
                                <mat-option *ngFor="let hour of getAvailableHours()" [value]="hour" (change)="selectedHour=$event.option.value;updatePrice()">
                                  {{ hour }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" style="width: calc(50% - 8px);" label="hour">
                              <mat-label>{{ 'hour' | translate }}</mat-label>
                              <mat-select [(value)]="selectedDuration">
                                <mat-option *ngFor="let duration of getAvailableDurations(selectedHour)" [value]="duration" (change)="selectedDuration=$event.option.value;updatePrice()">
                                  {{ duration + 'min' }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>-->
              <app-form-select style="width: calc(50% - 8px);" [value]="selectedHour" label="hour"
                               [table]="getAvailableHours()"
                               (do)="onHourSelected($event.option.value)"></app-form-select>

              <app-form-select style="width: calc(50% - 8px);" [value]="selectedDuration"
                               [table]="getAvailableDurations(selectedHour)" label="duration"
                               [readonly]="!course.is_flexible"
                               (do)="onDurationSelected($event.option.value)"></app-form-select>
            </div>
          </ng-container>
        </div>
        <div [style.display]="courseFlux===3 ? 'block' : 'none'" class="extras-section">

          <!-- Error message for date selection validation -->
          <div *ngIf="dateSelectionError" class="date-selection-error" style="margin-bottom: 20px;">
            <mat-icon>error_outline</mat-icon>
            <span>{{dateSelectionError}}</span>
          </div>

          <!-- Only show extras section if extras are available -->
          <ng-container *ngIf="settingsExtras && settingsExtras.length > 0">
            <div class="extras-title">
              <mat-icon>add_circle_outline</mat-icon>
              {{"add_extras_or_notes" |translate}}
            </div>

            <ng-container *ngIf="!(course?.course_type === 1 && course?.is_flexible === true)">
            <div *ngFor="let date of (course?.course_type === 1 ? (course?.is_flexible ? selectedDates : [course?.course_dates[0]]) : [selectedDateReservation?.date])"
                 class="extras-date-section">
              <div *ngIf="course.is_flexible" class="extras-date-header">
                {{date|date:'dd.MM.yyyy'}}
              </div>
              <div class="extras-grid">
                <mat-checkbox *ngFor="let extra of settingsExtras"
                              class="extra-checkbox"
                              (click)="toggleForfaitSelection(extra)">
                  <div class="extra-content">
                    <div class="extra-info">
                      <div class="extra-name">{{extra.name}}</div>
                      <div class="extra-description">{{extra.description}}</div>
                    </div>
                    <div class="extra-price">
                      {{extra.price|number:'0.2-2'}} {{course?.currency}}/{{'date' | translate}}
                    </div>
                  </div>
                </mat-checkbox>
              </div>
            </div>
          </ng-container>
          <ng-container *ngIf="course?.course_type === 1 && course?.is_flexible === true">
            <div *ngFor="let date of (course?.course_type === 1 ? (course?.is_flexible ? selectedDates : [course?.course_dates[0]]) : [selectedDateReservation?.date]) let i = index"
                 class="extras-date-section">
              <div class="extras-date-header">
                {{ (course.is_flexible ? date : '') | date:'dd.MM.yyyy' }}
              </div>

              <div class="extras-grid">
                <mat-checkbox *ngFor="let extra of settingsExtras"
                              [checked]="isExtraSelected(extra, date)"
                              class="extra-checkbox"
                              (change)="toggleForfaitSelectionCollective(extra, date)">
                  <div class="extra-content">
                    <div class="extra-info">
                      <div class="extra-name">{{ extra.name }}</div>
                      <div class="extra-description">{{ extra.description }}</div>
                    </div>
                    <div class="extra-price">
                      {{ extra.price | number:'0.2-2' }} {{ course?.currency }}/{{ 'date' | translate }}
                    </div>
                  </div>
                </mat-checkbox>
              </div>
            </div>
          </ng-container>
          </ng-container>
          <!-- End of extras section -->

          <div style="margin-top: 20px;">
            <mat-form-field appearance="outline" class="flex-auto" style="width: 100%">
              <mat-label>
                {{'text_observations' | translate}}
              </mat-label>
              <textarea matInput cols="3">
							</textarea>
            </mat-form-field>
          </div>
        </div>

        <div class="reservation-price-flex reservation-view2"
             style="padding: 10px 20px; border-top: 1px solid rgba(222, 230, 234, 1); border-bottom: 1px solid rgba(222, 230, 234, 1);">
          <div class="text-medium text-color uppercase">
            {{'text_price' | translate }}
          </div>
          <div *ngIf="!course.is_flexible || course.course_type===2" class="text-medium text-color">
            <span class="text-color text-medium fw-bold">{{course?.price|number:'0.2-2'}}</span>
            {{course.currency}}
          </div>
          <div *ngIf="course.is_flexible && course.course_type!==2" class="text-medium text-color">
            <!-- Precio con descuento aplicado -->
            <div *ngIf="hasActiveDiscount" style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">
              <span style="text-decoration: line-through; font-size: 13px; color: #999;">
                {{originalPrice|number:'0.2-2'}} {{course.currency}}
              </span>
              <span class="text-color text-medium fw-bold" style="color: #E91E63; font-size: 18px;">
                {{collectivePrice|number:'0.2-2'}} {{course.currency}}
              </span>
              <span style="font-size: 12px; color: #4CAF50; font-weight: 600;">
                {{'discount_save' | translate}} {{appliedDiscountAmount|number:'0.2-2'}} {{course.currency}}
              </span>
            </div>
            <!-- Precio sin descuento -->
            <span *ngIf="!hasActiveDiscount" class="text-color text-medium fw-bold">{{collectivePrice|number:'0.2-2'}}</span>
            <span *ngIf="!hasActiveDiscount">{{course.currency}}</span>
          </div>
        </div>
        <!-- Mensaje incentivador si hay descuentos disponibles -->
        <div *ngIf="course.is_flexible && hasDiscountsConfigured() && getNextDiscount()"
             style="margin: 16px 20px; padding: 12px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
          <div style="color: white; font-size: 13px; font-weight: 600; line-height: 1.5;">
            <div style="font-size: 18px; margin-bottom: 6px;">🎁</div>
            <div>{{'discount_add' | translate}} <strong style="font-size: 16px;">{{getNextDiscount().days - (selectedDates?.length || 0)}}</strong> {{'discount_more_days' | translate}}</div>
            <div style="margin-top: 8px; font-size: 14px; padding: 6px 12px; background: rgba(255,255,255,0.2); border-radius: 4px; display: inline-block;">
              {{'discount_save_up_to' | translate}}
              <strong style="font-size: 15px;" *ngIf="getNextDiscount().type === 'percentage'">{{getNextDiscount().value}}%</strong>
              <strong style="font-size: 15px;" *ngIf="getNextDiscount().type === 'fixed'">{{getNextDiscount().value}} {{course?.currency}}</strong>
            </div>
          </div>
        </div>
        <div style="padding: 20px;">
          <button
            [disabled]="
              (course.course_type===1 && courseFlux===0 && !selectedUser)
              || (course.course_type===2 && courseFlux===0 && (selectedUserMultiple.length<1))
              || (!selectedLevel && courseFlux===1)
              || (course.course_type===2 && courseFlux===2 && !selectedDateReservation)
              || (course.course_type===1 && course.is_flexible && courseFlux===2 && selectedDates.length===0)
            "
            (click)="next()" style="background-color: rgba(233, 30, 99, 1);width: 100%;border-radius: 3px;
              height: 50px;padding: 10px 12px;
              color: white;
              font-weight: 600;" type="button">
            {{'continue' | translate }}
          </button>
        </div>
        <!-- <div (click)="goTo(schoolData.slug)"
          class="text-color-light montserrat cursor-pointer reservation-return mt-12">
          <img [src]="themeService.arrowReturn">
          {{'text_delete_return_courses' | translate }}
        </div> -->
      </div>
    </div>
  </div>
</div>

<app-modal-add-user [slug]="schoolData?.slug" [isOpen]="isModalAddUser" (onClose)="isModalAddUser=false">
</app-modal-add-user>

<app-course-modal-confirm *ngIf="confirmModal" [course]="course" [selectedDates]="selectedCourseDates"
                          [selectedUsers]="course.course_type===1?[selectedUser]:selectedUserMultiple"
                          [selectedForfait]="selectedForfait"
                          [selectedForfaits]="selectedForfaits"
                          [selectedDuration]="selectedDuration"
                          [collectivePrice]="collectivePrice"
                          [originalPrice]="originalPrice"
                          [appliedDiscountAmount]="appliedDiscountAmount"
                          [hasActiveDiscount]="hasActiveDiscount"
                          [discountsByInterval]="discountsByInterval"
                          (onClose)="confirmModal=false"
                          (next)="addBookingToCart()">
</app-course-modal-confirm>


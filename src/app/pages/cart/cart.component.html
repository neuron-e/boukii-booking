<div (click)="goBack('home')" class="reservation-return">
	<span style="color: #61656d;">
		{{'menu.home' | translate }}
	</span>/<span style="font-weight: 600;">
		{{'cart' | translate }}
	</span>
</div>

<div class="reservation-return2">
	<span>
		{{cart.length}}
    {{'text_courses'|translate }}
    {{'text_your_cart'|translate }}
	</span>

  <button (click)="goBack('home')">
    {{'add_reservation'|translate}}
  </button>
</div>

<mat-spinner *ngIf="loading" style="margin: 0 auto"></mat-spinner>

<div class="cart-payment">
  <div *ngIf="!loading" class="cart-payment-section1">
    <div *ngFor="let cartItem of cart; index as i"
         style="background-color: white;border: 1px solid #DEE6EA;border-radius: 8px;">
      <div class="course-box">
        <div class="course-box-header">
          <div class="course-box-icon">
						<span>
							{{("00"+(i+1)).slice(-2)}}.
						</span>
            <img *ngIf="cartItem.details[0].course.course_type == 1 && cartItem.details[0].course.sport"
                 [src]="cartItem.details[0].course.sport.icon_collective">
            <img *ngIf="cartItem.details[0].course.course_type == 2 && cartItem.details[0].course.sport"
                 [src]="cartItem.details[0].course.sport.icon_prive">
            <img *ngIf="cartItem.details[0].course.course_type == 3 && cartItem.details[0].course.sport"
                 [src]="cartItem.details[0].course.sport.icon_activity">
            <div class="course-box-title">
              <div style="font-weight: 600;">
                {{getCourseName(cartItem.details[0].course)}}
              </div>
              <span style="color: #8B9099;font-size: 12px;">
								<ng-container *ngIf="cartItem.details[0].course.course_type==1">
									{{'colective' | translate }}
								</ng-container>
								<ng-container *ngIf="cartItem.details[0].course.course_type==2">
									{{'private' | translate }}
								</ng-container>
								<ng-container *ngIf="schoolData && schoolData.sports">
									{{ getSportName(cartItem.details[0].course.sport_id) }}
								</ng-container>
							</span>
            </div>
          </div>
          <div class="course-box-icons">
            <img [src]="themeService.add" (click)="goTo(schoolData.slug + '/course',cartItem.courseId)"
                 class="course-box-add cursor-pointer">
            <img [src]="themeService.trash" (click)="deleteCartItem(cartItem)"
                 class="course-box-delete cursor-pointer">
          </div>
        </div>
        <div class="course-box-dates">
          <div class="course-content-list">
            <div style="display: flex;align-items: center;gap: 8px;">
              <img src="assets/icons/people.png" class="icon24">
              <span style="
									color: #8B9099;
									font-size: 12px;
									font-weight: 600;
									line-height: 16px;
									word-wrap: break-word">
								{{"participants"|translate|uppercase}}
							</span>
            </div>
            <div *ngFor="let client of getUniqueClients(cartItem.details)"
                 class="text-color-light montserrat list-flex">
              <app-level-user [allLevels]="dataLevels"
                              [selectLevel]="getClientDegreeId(client, cartItem.details[0]?.course?.sport_id)"
                              [size]="40"
                              [userImage]="client.image || 'assets/images/avatar.png'"></app-level-user>
              {{ client.first_name + ' ' + client.last_name }}
            </div>
            <div style="display: flex;align-items: center;gap: 8px;">
              <img src="assets/icons/calendar.png" class="icon24">
              <span style="
								color: #8B9099;
								font-size: 12px;
								font-weight: 600;
								line-height: 16px;
								word-wrap: break-word">
								{{"date_time"|translate|uppercase}}
							</span>
            </div>

            <!-- Si hay mÃºltiples intervalos, agrupar por intervalo -->
            <ng-container *ngIf="hasIntervalGroups(cartItem); else singleIntervalDates">
              <div *ngFor="let interval of getCartItemDatesByInterval(cartItem)" style="width: 100%;">
                <div class="cart-interval-header">
                  <div class="cart-interval-title">
                    <span>{{interval.name}}</span>
                    <span class="cart-interval-count">({{interval.count}} {{'dates' | translate}})</span>
                  </div>
                  <div class="cart-interval-discount" *ngIf="interval.discountAmount > 0">
                    -{{interval.discountAmount|number:'0.2-2'}}
                    {{ cartItem.details[0].course.currency }}
                    <span class="cart-interval-discount__percent" *ngIf="interval.discountPercentage > 0">
                      (-{{interval.discountPercentage}}%)
                    </span>
                  </div>
                </div>
                <div *ngFor="let detail of interval.dates"
                     style="display: flex;justify-content: space-between;width: 100%;gap: 20px;padding-left: 8px;">
                  <span>
                    {{detail.date | date: 'dd.MM.yyyy'}}
                  </span>
                  <span style="color: gray;">
                    {{detail.hour_start.substring(0,5)}}-{{detail.hour_end.substring(0,5)}}
                  </span>
                </div>
              </div>
            </ng-container>

            <!-- Si hay un solo intervalo o ninguno, mostrar lista plana -->
            <ng-template #singleIntervalDates>
              <div *ngFor="let date of getUniqueDates(cartItem.details)"
                   style="display: flex;justify-content: space-between;width: 100%;gap: 20px;">
                <span>
                  {{date.date | date: 'dd.MM.yyyy'}}
                </span>
                <span style="color: gray;">
                  {{date.hour_start.substring(0,5)}}-{{date.hour_end.substring(0,5)}}
                </span>
              </div>
            </ng-template>
            <div style="display: flex;align-items: center;gap: 8px;"
                 *ngIf="cartItem.details[0].extra.length>0">
							<span style="
								color: #8B9099;
								font-size: 12px;
								font-weight: 600;
								line-height: 16px;
								word-wrap: break-word">
								{{"text_forfait"|translate|uppercase}}
							</span>
            </div>
            <div *ngIf="cartItem.details[0].extra.length>0"
                 style="display: flex; gap: 8px; justify-content: space-between; align-items: center; flex-wrap: wrap;margin-left: 10px;">
              <div *ngFor="let extra of cartItem.details[0].extra" style="width: 100%;">
                <div>
                  <span class="extra_product">{{extra.product}}</span>
                  <br>
                  <span class="extra_name">{{extra.name}}</span>
                </div>
                <span>
									{{extra.price|number:'0.2-2'}}{{cartItem.details[0].course.currency}} /{{'date' |
                  translate}}
                </span>
              </div>
            </div>
            <ng-container *ngIf="cartItem.details[0].course.course_type == 1 && cartItem.details[0].course.is_flexible">
              <ng-container *ngIf="getIntervalDiscountInfo(cartItem) as discountInfo">
                <div *ngIf="discountInfo.breakdown?.length > 0 || discountInfo.totalDiscount > 0" class="cart-price-breakdown">
                  <div class="cart-price-breakdown__row cart-price-breakdown__row--original"
                       *ngIf="discountInfo.originalPrice > discountInfo.finalPrice">
                    <span>{{'original_price' | translate }}</span>
                    <span>{{discountInfo.originalPrice|number:'0.2-2'}} {{ cartItem.details[0].course.currency }}</span>
                  </div>
                  <div *ngFor="let discount of discountInfo.breakdown" class="cart-price-breakdown__row cart-price-breakdown__row--interval">
                    <span>
                      {{discount.intervalName}}
                      <span *ngIf="discount.discountPercentage > 0">(-{{discount.discountPercentage}}%)</span>
                    </span>
                    <span>
                      -{{discount.discountAmount|number:'0.2-2'}} {{ cartItem.details[0].course.currency }}
                    </span>
                  </div>
                  <div class="cart-price-breakdown__row cart-price-breakdown__row--total" *ngIf="discountInfo.totalDiscount > 0">
                    <span>{{'discount_applied' | translate }}</span>
                    <span>-{{discountInfo.totalDiscount|number:'0.2-2'}} {{ cartItem.details[0].course.currency }}</span>
                  </div>
                  <div class="cart-price-breakdown__row cart-price-breakdown__row--final">
                    <span>{{'text_price' | translate }}</span>
                    <span>{{discountInfo.finalPrice|number:'0.2-2'}} {{ cartItem.details[0].course.currency }}</span>
                  </div>
                </div>
              </ng-container>
            </ng-container>
          </div>
        </div>
        <div class="course-box-dates" style="border-top: 1px solid #dee6ea;">
					<span style>
						{{"booking_total" | translate}}
					</span>
          <div class="text-color">
						<span class="text-color fw-semibold text-medium"
                  *ngIf="cartItem.details[0].course.course_type ==2">
							{{getTotalBasePrice(cartItem.details)|number:'0.2-2' }}
						</span>
            <span class="text-color fw-semibold text-medium"
                  *ngIf="cartItem.details[0].course.course_type ==1">
							{{(cartItem.details[0].course.is_flexible ?
              (cartItem.details[0].price) :
              cartItem.details[0].course.price * 1)|number:'0.2-2'}}
						</span>
            {{ cartItem.details[0].course.currency }}
          </div>
        </div>

        <!-- <div class="width-100">
          <div class="text-color mb-8">
            {{'text_notes' | translate }}
          </div>
          <textarea rows="2" class="form-control width-100"></textarea>
          </div> -->
      </div>
    </div>
  </div>
  <div *ngIf="cart?.length" class="background-color-trans rounded-8 payment-section2"
       style="background-color: white; height: fit-content;">
    <div class="cardcabecera">
      {{"purchase_summary" | translate}}
    </div>
    <div (click)="mobileHidden=!mobileHidden" class="cardcabecera2">
      <img *ngIf="!mobileHidden" src="assets/icons/down.png" alt>
      <img *ngIf="mobileHidden" src="assets/icons/up.png" alt>
    </div>
    <div [ngClass]="mobileHidden?'mobile':''" style="padding: 20px 20px 0;">
      <div *ngFor="let cartItem of cart;index as i" style="display: flex;align-items: center;min-height: 28px;">
				<span class="priceTotal">
					{{("00"+(i+1)).slice(-2)}}.
				</span>
        <span class="detail" style="margin-left: 5px;">
					{{cartItem.details[0].course.name }}
          <!--{{getSportName(cartItem.details[0].course.sport_id)}}-->
				</span>
        <span *ngIf="cartItem.details[0].course.course_type ==2" class="detailPrice">
					{{ getTotalBasePrice(cartItem.details)|number:'0.2-2' }} {{
            cartItem.details[0].course.currency }}
				</span>
        <span *ngIf="cartItem.details[0].course.course_type ==1" class="detailPrice">
          {{(cartItem.details[0].course.is_flexible ?
          cartItem.details[0].price :
          cartItem.details.length * cartItem.details[0].course.price)|number:'0.2-2'}}
          {{ cartItem.details[0].course.currency }}
        </span>
      </div>

      <div *ngIf="getExtrasPrice()>0" class="payment-price-flex mt-8">
        <div class="detail">
          {{'text_forfait' | translate }}
        </div>
        <div class="text-color min-width-price">
					<span class="detailPrice">
						{{getExtrasPrice()|number:'0.2-2'}}
            {{ cart[0].details[0].course.currency }}
					</span>
        </div>
      </div>

      <div *ngIf="hasBoukiiCare" class="payment-price-flex mt-8">
        <div class="detail">Boukii Care</div>
        <div class="text-color min-width-price">
					<span class="detailPrice">
						{{getBoukiiCarePrice()|number:'0.2-2'}}
            {{ cart[0].details[0].course.currency }}
					</span>
        </div>
      </div>

      <div *ngIf="totalIntervalDiscounts > 0" class="payment-price-flex mt-8 payment-original-row">
        <div class="detail">
          {{'original_price' | translate }}
        </div>
        <div class="text-color min-width-price">
					<span class="detailPrice payment-original-line">
						{{originalBasePrice|number:'0.2-2'}}
            {{ cart[0].details[0].course.currency }}
					</span>
        </div>
      </div>

      <div class="payment-price-flex"
           style="margin: 16px 0; padding: 16px 0;border-top: 1px solid #DEE6EA;border-bottom: 1px solid #DEE6EA;">
        <div class="bdetail">
          {{'text_subtotal' | translate }}
        </div>
        <div class="text-color min-width-price">
					<span class="detailPrice">
						{{basePriceValue|number:'0.2-2'}}
            {{ cart[0].details[0].course.currency }}
					</span>
        </div>
      </div>

      <!-- Interval Discounts Breakdown -->
      <div *ngIf="totalIntervalDiscounts > 0" class="payment-discount-detail">
        <div *ngFor="let cartItem of cart; index as i" class="payment-discount-detail__course">
          <div class="payment-discount-detail__course-name">
            {{("00"+(i+1)).slice(-2)}}.&nbsp;{{cartItem.details[0].course.name}}
          </div>
          <ng-container *ngIf="getIntervalDiscountInfo(cartItem) as discountInfo">
            <div *ngIf="discountInfo.breakdown && discountInfo.breakdown.length > 0">
              <div *ngFor="let discount of discountInfo.breakdown" class="payment-discount-detail__row">
                <div>
                  {{discount.intervalName}}
                  <span *ngIf="discount.discountPercentage > 0" class="payment-discount-detail__percent">
                    ({{discount.discountPercentage}}%)
                  </span>
                </div>
                <div class="payment-discount-detail__amount">
                  -{{discount.discountAmount|number:'0.2-2'}}
                  {{ cartItem.details[0].course.currency }}
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <div *ngIf="totalIntervalDiscounts > 0" class="payment-price-flex payment-discount-row">
        <div class="detail">
          {{'discount_applied' | translate }}
        </div>
        <div class="text-color min-width-price">
          <span class="text-color fw-bold payment-discount-amount">
            -{{totalIntervalDiscounts|number:'0.2-2'}}
          </span>
          {{ cart[0].details[0].course.currency }}
        </div>
      </div>

      <div *ngIf="hasInsurance" class="payment-price-flex mt-8">
        <div class="detail">
          {{'text_refund_option' | translate }}
        </div>
        <div class="text-color min-width-price">
					<span class="detailPrice">
						{{getInsurancePrice()|number:'0.2-2'}}
            {{ cart[0].details[0].course.currency }}
					</span>
        </div>
      </div>

      <div *ngIf="vouchers.length > 0" class="voucher-price-flex mt-8">
        <div *ngFor="let voucher of vouchers" class="voucher-item payment-price-flex">
          <div class="text-color uppercase voucher-info">
            <img [src]="themeService.trash" (click)="removeVoucher(voucher);"
                 style="display: inline-flex !important;"
                 class="course-box-delete cursor-pointer">
            <div>
              <div>
                {{'text_voucher' | translate }} - {{voucher.code}}
                <span class="voucher-badge" *ngIf="voucher.is_generic">{{'text_generic_voucher' | translate }}</span>
              </div>
              <div class="voucher-remaining">
                {{'remaining_balance' | translate }}:
                {{ (voucher.remaining_balance ?? 0)|number:'0.2-2' }}
                {{ cart[0].details[0].course.currency }}
              </div>
            </div>
          </div>
          <div class="text-color min-width-price">
            <span class="text-color fw-bold">
              -{{voucher.reducePrice|number:'0.2-2'}}
            </span>
            {{ cart[0].details[0].course.currency }}
          </div>
        </div>
      </div>

      <div *ngIf="!isNanValue(this.cancellationInsurance) && this.cancellationInsurance > 0"
           class="payment-refund-check">
        <input [(ngModel)]="hasInsurance" (change)="updateTotal()" type="checkbox" id="text_refund_option">
        <label class="extra_add" for="text_refund_option">
          {{'text_refund_option' | translate }}
        </label>
      </div>

      <div *ngIf="!isNanValue(this.boukiiCarePrice) && this.boukiiCarePrice > 0" class="payment-refund-check">
        <input [(ngModel)]="hasBoukiiCare" (change)="updateTotal()" type="checkbox" id="BoukiiCare">
        <label class="extra_add" for="BoukiiCare">
          Boukii Care
        </label>
      </div>
      <div *ngIf="calculateRemainingTotal() != 0" (click)="openModalVoucher()" style="display: flex;align-items: center;height: 40px;cursor: pointer;">
        <img src="assets/icons/add_red.png" class="icon24" style="margin: 0 8px;">
        <span class="extra_add" style="margin-left: 4px;">
          {{'text_use_voucher' | translate }}
        </span>
      </div>

      <!-- Discount Code Section -->
      <div *ngIf="!appliedDiscountCode && calculateRemainingTotal() != 0" (click)="openDiscountModal()" style="display: flex;align-items: center;height: 40px;cursor: pointer;">
        <img src="assets/icons/add_red.png" class="icon24" style="margin: 0 8px;">
        <span class="extra_add" style="margin-left: 4px;">
          {{'text_apply_discount_code' | translate }}
        </span>
      </div>

      <!-- Applied Discount Code -->
      <div *ngIf="appliedDiscountCode" class="payment-price-flex mt-8">
        <div class="text-color uppercase">
          <img [src]="themeService.trash" (click)="removeDiscountCode()"
               style="display: inline-flex !important;"
               class="course-box-delete cursor-pointer">
          {{'text_code_discount' | translate }} - {{appliedDiscountCode.discount_code.code}}
        </div>
        <div class="text-color min-width-price">
          <span class="text-color fw-bold">
            -{{discountCodeAmount|number:'0.2-2'}}
          </span>
          {{ cart[0].details[0].course.currency }}
        </div>
      </div>

      <div *ngIf="hasTva" class="payment-price-flex mt-8"
           style="margin: 16px 0; padding: 16px 0;border-top: 1px solid #DEE6EA;border-bottom: 1px solid #DEE6EA;">
        <div class="bdetail">
          {{'text_tva' | translate }}
        </div>
        <div class="text-color min-width-price">
					<span class="detailPrice">
						{{(totalNotaxes * tva)|number:'0.2-2'}}
            {{ cart[0].details[0].course.currency }}
					</span>
        </div>
      </div>

    </div>
    <div style="padding-bottom: 20px;">
      <div class="payment-price-flex mt-8"
           style="margin: 16px 0; padding: 16px 20px;border-top: 1px solid #DEE6EA;border-bottom: 1px solid #DEE6EA;">
        <div class="bdetail">
          {{'text_total' | translate }}
        </div>
        <div class="text-color min-width-price">
					<span class="detailPrice">
						{{totalPrice|number:'0.2-2'}}
            {{ cart[0].details[0].course.currency }}
					</span>
        </div>
      </div>

      <div style="padding: 0 20px;">
        <div [ngClass]="mobileHidden?'mobile':''" class="payment-conditions">
          <div class="checkbox-custom">
            <input [(ngModel)]="conditionsAccepted" type="checkbox" id="conditions">
            <label for="conditions" class="checkbox-custom-label-normal montserrat"></label>
          </div>
          <div for="conditions" class="checkbox-custom-label-normal montserrat">
            {{'text_i_accept_terms' | translate }}
            <span (click)="openModalConditions()" style="color: #E91E63;">
							{{'text_booking_conditions'
              | translate }}
						</span>
          </div>
        </div>
        <div [ngClass]="mobileHidden?'mobile':''" style="font-family: DM Sans;
				font-weight: 400;
				font-size: 12px;
				line-height: 16px;
				letter-spacing: 0px;
				">
          {{'text_payment2' | translate }}
        </div>
        <button [disabled]="!conditionsAccepted" (click)="sendBooking()"
                class="rounded-8 button-style cursor-pointer width-100" type="button" style="margin-top: 10px;height: 48px;color: white;
           font-size: 16px;
           background-color: #E91E63;
           font-weight: 600;
           border-radius: 3px;
           line-height: 20px;
           word-wrap: break-word">
          {{'text_end_and_pay' | translate }}
        </button>
        <div class="payment-title-icon mt-12 pt-12 text-color fw-semibold text-medium paymenthide">
          <img src="/assets/icons/payment_landing_pink.svg">
          {{'text_payment1' | translate }}
        </div>
        <img [src]="themeService.logoPay" class="payment-logo-pay mt-12 paymenthide">
      </div>
    </div>
  </div>
</div>

<app-modal-voucher
  [isOpen]="isModalVoucher"
  [slug]="schoolData?.slug"
  [vouchers]="vouchers"
  (onClose)="closeModalVoucher($event)">
</app-modal-voucher>
<app-modal-conditions *ngIf="schoolData?.slug != 'ess-charmey'" [isOpen]="isModalConditions"
                      [data]="'conditions_html' | translate" (onClose)="closeModalConditions()"></app-modal-conditions>
<app-modal-conditions *ngIf="schoolData?.slug == 'ess-charmey'" [isOpen]="isModalConditions" [data]="conditionsHTML"
                      (onClose)="closeModalConditions()"></app-modal-conditions>
<app-modal-discount-code
  [isOpen]="isDiscountCodeModalOpen"
  [slug]="schoolData?.slug"
  [cartTotal]="getDiscountValidationAmount()"
  [courseIds]="getCartCourseIds()"
  [sportIds]="getCartSportIds()"
  [degreeIds]="getCartDegreeIds()"
  (onClose)="closeDiscountModal()"
  (onApply)="applyDiscountCode($event)">
</app-modal-discount-code>



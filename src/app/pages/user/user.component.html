<div (click)="goBack('home')" class="reservation-return">
  <span style="color: #61656d;">
    {{'menu.home' | translate }}
  </span>
  /
  <span style="font-weight: 600;">
    {{'users' | translate }}
  </span>
</div>

<mat-spinner *ngIf="loading" style="margin: 0 auto">
</mat-spinner>

<div *ngIf="!loading" class="dimension">
  <div class="userd">
    <div class="flex flex-col md:flex-row md:items-start flex-sections-user-left">
      <div style="margin-left:0; margin-right: 1.5rem;max-width: initial !important;"
        class="card max-w-unset md:max-w-xs w-full flex-none md:ltr:ml-6 md:rtl:mr-6 mt-6 md:mt-0">
        <div class="flex flex-col" style="cursor:pointer;">
          <div style="height: 64px;padding: 10px;">
            <button (click)="isModalAddUser=true"
              style="background-color: white; border: 1px solid black; border-radius: 3px;height: 40px;padding: 10px 12px;width: 100%;font-weight: 600; word-wrap: break-word">
              {{"add_user" | translate}}
            </button>
          </div>
          <div [style.background]="id===userLogged.clients[0].id?'#DEE6EA':''"
            (click)="id = userLogged.clients[0].id; this.getData()" class="flex items-center"
            style="display:flex;width:100%;align-items:center;gap:10px;padding: 20px;border: 1px solid #DEE6EA;">
            <app-level-user [allLevels]="allLevels"
                            [selectLevel]="userLogged.clients[0]?.sports?.length ? userLogged.clients[0]?.sports[0]?.pivot?.degree_id : 0"
                            [size]="40"
              [userImage]="userLogged.clients[0]?.image" style="z-index: 0;"></app-level-user>
            <div class="body-2 m-0 leading-snug montserrat" style="font-size:13px;color:black">
              {{
              userLogged.clients[0]?.first_name }} {{
              userLogged.clients[0]?.last_name }}
            </div>
            <img *ngIf="id===userLogged.clients[0].id" src="assets/icons/arrow-right2.png" alt class="icon24"
              style="margin-left: auto;">
          </div>
          <div *ngFor="let user of clientUsers" [style.background]="id===user.id?'#DEE6EA':''"
            (click)="id=user.id;this.getData()" class="flex items-center"
            style="display:flex;width:100%;align-items:center;gap:10px;padding: 20px;border: 1px solid #DEE6EA;">
            <app-level-user [allLevels]="allLevels" [selectLevel]="user.client_sports[0]?.degree_id || 0" [size]="40"
              [userImage]="user?.image" style="z-index: 0;"></app-level-user>
            <div class="body-2 m-0 leading-snug montserrat" style="font-size:13px;color:black">
              {{ user?.first_name
              }} {{
              user?.last_name }}
            </div>
            <img *ngIf="id===user.id" src="assets/icons/arrow-right2.png" alt class="icon24" style="margin-left: auto;">
          </div>
        </div>
      </div>
    </div>
  </div>

  <mat-tab-group (selectedIndexChange)="onTabChange($event)" class="tabsWrapper">
    <mat-tab label="{{'data' | translate}}">
      <app-user-detail #userDetail [idParent]="id" (idChange)="id=$event;this.getData()" [goals]="sportCard"></app-user-detail>
    </mat-tab>
    <mat-tab label="{{'sports' | translate}}">
      <div>
        <div style="display: flex;
          gap: 20px;
          margin: 30px 5px;
          flex-wrap: nowrap;
          justify-content: space-evenly;
          overflow-x: auto;">
          <button *ngFor="let sport of clientSport"
            [style.color]="selectedSport.sport_id==sport.sport_id?'white':'black'"
            [style.background]="selectedSport.sport_id==sport.sport_id?'black':'white'" (click)="selectSportEvo(sport)"
            style="border: 1px solid black;border-radius: 3px;height: 40px;min-width: 150px;word-wrap: break-word">
            {{sport.name}}
          </button>
        </div>
        <div class="sportCard">
          <span style="color: #8B9099;
           font-size: 12px;
           font-weight: 600;
           line-height: 16px;
           word-wrap: break-word">
            {{'sport_evolution' | translate }}
          </span>
          <div #sliderContainer (scroll)="onScroll()" class="flowcard">
            <div *ngIf="!loading && selectedSport && sportCard.length>0" class="arrowflowcard">
              <img (click)="scrollLeft(-1)" src="assets/icons/arrow-left-1.png" style="cursor: pointer;"
                class="icon60 flecha">
              <img (click)="scrollLeft(1)" src="assets/icons/arrow-right-1.png" style="cursor: pointer;"
                class="icon60 flecha">
            </div>
            <div *ngIf="!loading && selectedSport && sportCard.length>0" class="flex-sections-user flowcardGroup">
              <app-user-detail-sport-card *ngFor="let item of sportCard; index as i" [selectedSport]="selectedSport"
                [level]="item.degree" [goals]="item.goals" [center]="i === centeredCardIndex">
              </app-user-detail-sport-card>
            </div>
            <!-- Empty state cuando no hay deportes -->
            <div *ngIf="!loading && (!selectedSport || sportCard.length === 0)"
                 style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; color: #8B9099;">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.3; margin-bottom: 16px;">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 6v6l4 2"></path>
              </svg>
              <p style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: #374151;">
                {{ 'no_sports_yet' | translate }}
              </p>
              <p style="margin: 0; font-size: 14px; color: #8B9099; max-width: 300px;">
                {{ 'add_sports_message' | translate }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="{{'bookings' | translate }}">

      <div *ngIf="!loading && !selectedBooking" style="max-width: none">

        <div class="flex-auto">
          <table *ngIf="bookings" [dataSource]="bookings" mat-table class="mat-elevation-z8">

            <ng-container matColumnDef="icon">
              <th *matHeaderCellDef mat-header-cell>
                {{'type' | translate}}
              </th>
              <td *matCellDef="let element" mat-cell style="height: 80px; width: 80px">
                <img [src]="element.sport" class="avatar h-8 w-8 align-middle"
                  style="border-radius: 5px; height: 70%; width: 100%;">
              </td>
            </ng-container>

            <ng-container matColumnDef="dates">
              <th *matHeaderCellDef mat-header-cell>
                {{ 'dates' | translate }}
              </th>
              <td *matCellDef="let element" (click)="selectBooking(element.id)" mat-cell>
                <strong>
                  {{ getMinMaxDates(element.booking_users).minDate | date:'dd/MM/YYYY' }}
                  <br>
                  {{ getMinMaxDates(element.booking_users).maxDate | date:'dd/MM/YYYY' }}
                </strong>
                <br>
                {{getMinMaxHours(element.booking_users).minHour }}h -
                {{getMinMaxHours(element.booking_users).maxHour}}h
              </td>
            </ng-container>

            <ng-container matColumnDef="booking_users[0].course.name">
              <th *matHeaderCellDef mat-header-cell>
                {{ 'course' | translate }}
              </th>
              <td *matCellDef="let element" (click)="selectBooking(element.id)" mat-cell>
                {{ getCourseName(element.booking_users[0]?.course) || 'N/A'}}
              </td>
            </ng-container>

<!-- BOUKII CARE DESACTIVADO -             <ng-container matColumnDef="has_boukii_care">
              <th *matHeaderCellDef class="uppercase" mat-header-cell>
                {{ 'has_boukii_Care' | translate }}
              </th>
              <td *matCellDef="let element" (click)="selectBooking(element.id)" mat-cell>
                <div *ngIf="element.has_boukii_care"
                  style="background-color: #CEE741;width: 25px;border-radius: 100%;height: 25px;margin: 0 auto;">
                </div>
                <div *ngIf="!element.has_boukii_care"
                  style="background-color: #E6E6E6;width: 25px;border-radius: 100%;height: 25px;margin: 0 auto;">
                </div>
              </td>
            </ng-container> -->

            <ng-container matColumnDef="has_cancellation_insurance">
              <th *matHeaderCellDef class="uppercase" mat-header-cell>
                {{ 'text_refund_option' | translate }}
              </th>
              <td *matCellDef="let element" (click)="selectBooking(element.id)" mat-cell>
                <div *ngIf="element.has_cancellation_insurance"
                  style="background-color: #CEE741;width: 25px;border-radius: 100%;height: 25px;margin: 0 auto;">
                </div>
                <div *ngIf="!element.has_cancellation_insurance"
                  style="background-color: #E6E6E6;width: 25px;border-radius: 100%;height: 25px;margin: 0 auto;">
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="payment_method">
              <th *matHeaderCellDef mat-header-cell>
                {{ 'payment_method' | translate }}
              </th>
              <td *matCellDef="let element" mat-cell>
                {{ getPaymentMethod(element.payment_method_id || element.payment_method) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="payment_status">
              <th *matHeaderCellDef class="uppercase" mat-header-cell>
                {{ 'ispaid' | translate }}
              </th>
              <td *matCellDef="let element" mat-cell>
                <div *ngIf="element.paid"
                  style="background-color: #CEE741;width: 25px;border-radius: 100%;height: 25px;margin: 0 0 0 5%;">
                </div>
                <div *ngIf="!element.paid"
                  style="background-color: #E6E6E6;width: 25px;border-radius: 100%;height: 25px;margin: 0 0 0 5%;">
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="cancelation_status">
              <th *matHeaderCellDef class="uppercase" mat-header-cell>
                {{ 'status' | translate }}
              </th>
              <td *matCellDef="let element" mat-cell>
                {{ element.cancellation_status }}
              </td>
            </ng-container>

            <ng-container matColumnDef="price_total">
              <th *matHeaderCellDef mat-header-cell>
                {{ 'price' | translate }}
              </th>
              <td *matCellDef="let element" (click)="selectBooking(element.id)" mat-cell>
                {{ element.price_total }} {{ element.price_currency || element.currency || 'CHF' }}
              </td>
            </ng-container>

            <tbody>
              <tr *matHeaderRowDef="displayedColumns" mat-header-row></tr>
              <tr *matRowDef="let row; columns: displayedColumns;" mat-row style="cursor: pointer;"></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div style="width:100%;" *ngIf="selectedBooking">
        <booking-detail-v2
          [bookingId]="bookingId"
          [bookingData]="selectedBookingData"
          (bookingUpdated)="onBookingUpdated($event)"
          (bookingCancelled)="onBookingCancelled($event)"
          (closeBooking)="hideBooking()"></booking-detail-v2>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>

<app-modal-add-user [slug]="schoolData?.slug" [isOpen]="isModalAddUser" (onClose)="isModalAddUser=false">
</app-modal-add-user>
